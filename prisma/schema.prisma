generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int          @id @default(autoincrement())
  nome       String
  email      String       @unique
  senha      String
  telefone   String
  cargoID    Int
  pedidos    Pedido[]
  cargo      Cargo        @relation(fields: [cargoID], references: [id])
  deletedAt DateTime? 
  caixasAbertos LivroCaixa[] @relation("CaixaAbertoPor")
  fechamentos Fechamento[]
  movimentacoesFinanceiras MovimentacaoFinanceira[] 
}

model Permissoes {
  id        Int     @id @default(autoincrement())
  nome      String  @unique
  descricao String?
  cargos     Cargo[]  @relation("UserPermissions")
}

model Cargo {
  id    Int    @id @default(autoincrement())
  nome  String @unique
  permissoes Permissoes[] @relation("UserPermissions")
  users User[]
}

model Registro {
  id              Int              @id @default(autoincrement())
  nome_razao      String
  apelido         String?
  tipo            TipoRegistro
  tabelaID        Int
  email           String?
  telefone        String?
  criadoEm        DateTime         @default(now())
  dados_pagamento DadosPagamento?
  endereco        Endereco?
  pedidos         Pedido[]
  fisica          PessoaFisica?
  juridica        PessoaJuridica?
  tabela          Tabela           @relation(fields: [tabelaID], references: [id])
  saldo           SaldoFinanceiro?
  deletedAt       DateTime?
  contas          ContaFinanceira[]
}

model PessoaFisica {
  id         Int       @id @default(autoincrement())
  cpf        String    @unique
  nascimento DateTime?
  registroID Int @unique
  registro   Registro  @relation(fields: [registroID], references: [id])
}

model PessoaJuridica {
  id       Int      @id @default(autoincrement())
  cnpj     String   @unique
  ie       String?
  fantasia String?
  registroID Int @unique
  registro Registro @relation(fields: [registroID], references: [id])
}

model SaldoFinanceiro {
  id       Int      @id @default(autoincrement())
  regID    Int      @unique
  saldo    Decimal @db.Decimal(10,2)
  registro Registro @relation(fields: [regID], references: [id])
}

model Endereco {
  id          Int      @id @default(autoincrement())
  regID       Int      @unique
  cep         String?
  estado      String?
  cidade      String?
  bairro      String?
  logradouro  String?
  numero      String?
  complemento String?
  registro    Registro @relation(fields: [regID], references: [id])
}

model DadosPagamento {
  id       Int      @id @default(autoincrement())
  banco    String?
  agencia  String?
  conta    String?
  chave    String?
  cpf      String?
  regID    Int      @unique
  registro Registro @relation(fields: [regID], references: [id])
}

model Tabela {
  id        Int              @id @default(autoincrement())
  nome      String           @unique
  updatedAt DateTime         @default(now()) @updatedAt
  materiais PrecoPorTabela[]
  registros Registro[]
}

model PrecoPorTabela {
  id         Int      @id @default(autoincrement())
  v_compra   Decimal @db.Decimal(10,2)
  materialID Int
  tabelaID   Int
  editadoEm  DateTime @default(now()) @updatedAt
  material   Material @relation(fields: [materialID], references: [id])
  tabela     Tabela   @relation(fields: [tabelaID], references: [id])
}

model Material {
  id            Int                   @id @default(autoincrement())
  nome          String                @unique
  catID         Int
  v_venda       Decimal @db.Decimal(10,2)
  estoque       Decimal @db.Decimal(10,2)
  criado_em     DateTime              @default(now())
  editado_em    DateTime              @default(now()) @updatedAt
  status        Boolean               @default(true)
  items         ItemPedido[]
  categoria     CategoriaMaterial     @relation(fields: [catID], references: [id])
  movimentacoes MovimentacaoEstoque[]
  preco_tabela  PrecoPorTabela[]
}

model CategoriaMaterial {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  materiais Material[]
}

model ItemPedido {
  id         Int      @id @default(autoincrement())
  pedidoID   Int
  materialID Int
  preco      Decimal @db.Decimal(10,2)
  quantidade Decimal @db.Decimal(10,2)
  pesoBruto Decimal @db.Decimal(10,2)
  tara       Decimal @db.Decimal(10,2)
  impureza   Decimal @db.Decimal(10,2)
  subtotal    Decimal @db.Decimal(10,2)
  material   Material @relation(fields: [materialID], references: [id])
  pedido     Pedido   @relation(fields: [pedidoID], references: [id], onDelete: Cascade)
}

model Pedido {
  id          Int              @id @default(autoincrement())
  regID       Int?
  caixaID     Int             
  tipo        TipoPedido
  valor_total Decimal @db.Decimal(10,2)          @default(0)
  status      TipoStatusPedido @default(ABERTO)
  userID      Int
  criado_em   DateTime         @default(now())
  atualizado  DateTime         @updatedAt
  items       ItemPedido[]
  pagamentos  ContaFinanceira[]
  caixa       LivroCaixa       @relation(fields: [caixaID],references: [id])
  registro    Registro?        @relation(fields: [regID], references: [id])
  user        User             @relation(fields: [userID], references: [id])
}

model ContaFinanceira {
  id        Int                   @id @default(autoincrement())
  tipo      TipoConta
  pedidoID  Int?
  registroID Int?
  descricao   String?
  valor     Decimal @db.Decimal(10,2)
  data_documento DateTime     @default(now())
  data_vencimento DateTime?
  data_pagamento DateTime?
  forma     FormaPagamento
  data      DateTime              @default(now())
  pedido    Pedido?                @relation(fields: [pedidoID], references: [id])
  registro Registro? @relation(fields: [registroID],references: [id])
  movimentacao  MovimentacaoFinanceira?
}

model Banco {
  id            Int                      @id @default(autoincrement())
  nome          String
  saldo         Decimal @db.Decimal(10,2)
  movimentacoes MovimentacaoFinanceira[]
}

model MovimentacaoFinanceira {
  id               Int                   @id @default(autoincrement())
  estornoID        Int? @unique
  bancoID          Int?
  caixaID          Int
  contaID          Int? @unique
  categoriaID      Int?
  tipoMovimentacaoID Int
  data             DateTime              @default(now())
  saldoInicial       Decimal @db.Decimal(10,2)
  valor            Decimal @db.Decimal(10,2)
  saldoFinal       Decimal @db.Decimal(10,2)
  descricao        String?
  userID           Int
  estornadoEm        DateTime?
  banco            Banco?                 @relation(fields: [bancoID], references: [id])
  caixa            LivroCaixa @relation(fields: [caixaID],references: [id])
  conta           ContaFinanceira? @relation(fields: [contaID],references: [id])
  categoria       CategoriaCaixa?    @relation(fields: [categoriaID],references: [id])
  user            User  @relation(fields:[userID],references:[id])
  tipoMovimentacao  Caixa_TipoMovimentacao @relation(fields: [tipoMovimentacaoID],references: [id])
  estorno         MovimentacaoFinanceira? @relation("Estorno",fields: [estornoID],references: [id])
  movimentacaoEstorno MovimentacaoFinanceira? @relation("Estorno")
  
  
  
}
model Caixa_TipoMovimentacao {
  id Int @id @default(autoincrement())
  nome String @unique
  tipo DirecaoMovimentacao
  movimentacoes MovimentacaoFinanceira[]
}


model CategoriaCaixa {
  id Int @id @default(autoincrement())
  nome String
  deletedAt DateTime? 
  movimentacoes MovimentacaoFinanceira[]
}

model MovimentacaoEstoque {
  id                 Int                       @id @default(autoincrement())
  materialID         Int
  tipoMovimentacao   DirecaoMovimentacao
  origem             OrigemMovimentacaoEstoque
  origemID           Int?
  devolucaoID        Int?                      @unique         
  quantidade         Decimal @db.Decimal(10,2)
  createdAt          DateTime                  @default(now())
  devolvidaEm        DateTime?
  observacao        String?
  material           Material                  @relation(fields: [materialID], references: [id])
  devolucao         MovimentacaoEstoque?       @relation("Devolucao",fields: [devolucaoID],references: [id])
  movimentacaoDevolvida MovimentacaoEstoque?   @relation("Devolucao")
}

model ConversaoEstoque {
  id            Int                   @id @default(autoincrement())
  mat_origemID  Int
  mat_destinoID Int
  quantidade    Decimal @db.Decimal(10,2)
  descricao     String?
  createdAt     DateTime              @default(now())
}
model LivroCaixa {
  id             Int                     @id @default(autoincrement())
  dataAbertura   DateTime                @default(now())
  dataFechamento DateTime?
  abertoPorID    Int
  saldoInicial   Decimal @db.Decimal(10,2)
  saldoFinal     Decimal @db.Decimal(10,2)
  status         StatusCaixa             @default(ABERTO)
  abertoPor      User                    @relation("CaixaAbertoPor",fields: [abertoPorID],references: [id])
  movimentacoes  MovimentacaoFinanceira[]
  pedidos        Pedido[]
  fechamento Fechamento?
}
model Fechamento {
  id      Int  @id @default(autoincrement())
  caixaID   Int @unique
  caixa LivroCaixa @relation(fields: [caixaID],references: [id])
  valor_abertura  Decimal @db.Decimal(10,2)       
  valor_abastecimentos Decimal @db.Decimal(10,2)
  valor_despesas Decimal @db.Decimal(10,2)
  data_abertura DateTime
  data_fechamento DateTime
  userID_fechamento Int
  user_fechamento User @relation(fields: [userID_fechamento],references: [id])
  valor_esperado Decimal @db.Decimal(10,2)
  //valor_pago Decimal @db.Decimal(10,2)
  //valor_recebido Decimal @db.Decimal(10,2)
  valor_total_compras Decimal @db.Decimal(10,2)
  valor_total_vendas Decimal @db.Decimal(10,2)
  peso_total_compras Decimal @db.Decimal(10,2)
  peso_total_vendas Decimal @db.Decimal(10,2)
  //lucro_total Decimal @db.Decimal(10,2)
  //proj_lucro Decimal @db.Decimal(10,2)
  //proj_venda Decimal @db.Decimal(10,2)
  qnt_compras Decimal @db.Decimal(10,2)
  qnt_vendas Decimal @db.Decimal(10,2)
  


}
enum DirecaoMovimentacao {
  ENTRADA
  SAIDA
}
enum TipoConta {
  PAGAR
  RECEBER
}
enum StatusCaixa {
  ABERTO
  FECHADO
}
enum TipoRegistro {
  FISICA
  JURIDICA
}

enum TipoPedido {
  COMPRA
  VENDA
}

enum TipoStatusPedido {
  ABERTO
  FECHADO
}



enum FormaPagamento {
  DINHEIRO
  PIX
  TRANSFERENCIA
  ABATER
}


enum TipoMovimentacaoEstoque {
  VENDA
  COMPRA
  ENTRADA_MANUAL
  SAIDA_MANUAL
  ENTRADA_CONVERSAO
  SAIDA_CONVERSAO
}

enum OrigemMovimentacaoEstoque {
  PEDIDO
  CONVERSAO
  AVULSO
  AJUSTE
  DEVOLUCAO
}
